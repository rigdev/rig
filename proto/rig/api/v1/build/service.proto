syntax = "proto3";

package api.v1.build;

import "google/protobuf/timestamp.proto";
import "api/v1/capsule/build.proto";
import "model/common.proto";

service Service {
  // Get Information about an image in a build.
  rpc GetImageInfo(GetImageInfoRequest) returns (GetImageInfoResponse) {}
  // Get Information about a docker registry repository.
  rpc GetRepositoryInfo(GetRepositoryInfoRequest)
      returns (GetRepositoryInfoResponse) {}
  // Get a build.
  rpc Get(GetRequest) returns (GetResponse) {}
  // Create a new build.
  // Builds are immutable and cannot change. Create a new build to make
  // changes from an existing one.
  rpc Create(CreateRequest) returns (CreateResponse) {}
  // List builds for a capsule.
  rpc List(ListRequest) returns (ListResponse) {}
  // Delete a build.
  rpc Delete(DeleteRequest) returns (DeleteResponse) {}
}

// Request to get information about an image.
message GetImageInfoRequest {
  // The image to get information about.
  string image = 1;
}

// Reponse to GetImageInfo request, containing information about an image.
message GetImageInfoResponse {
  // Image ID.
  ImageId image_id = 1;
  // Image from the request.
  string image_string = 2;
  // When the image was created.
  google.protobuf.Timestamp created_at = 3;
  // Origin of the image.
  api.v1.capsule.Origin origin = 4;
}

// A collection of image properties that uniquely identifies an image.
message ImageId {
  // Docker Registry.
  string registry = 1;
  // Docker Repository.
  string repository = 2;
  // Tag of the image.
  string tag = 3;
  // Digest of the image.
  string digest = 4;
}

// Get repository information request.
message GetRepositoryInfoRequest {
  // Docker Registry
  string registry = 1;
  // Docker Repository
  string repository = 2;
}

// Get repository information response.
message GetRepositoryInfoResponse {
  // Image Tags in the repository.
  repeated Tag tags = 1;
}

// A docker image tag.
message Tag {
  // Tag of the image.
  string tag = 1;
  // When the image was created.
  google.protobuf.Timestamp image_created_at = 2;
}

// Request to create a new build in a capsule.
message CreateRequest {
  // Capsule to create the build in.
  string capsule_id = 1;
  // Image to create the build from.
  string image = 2;
  // Digest of the image.
  string digest = 3;
  // Origin of the image
  api.v1.capsule.Origin origin = 4;
  // Meta data to attach to the build.
  map<string, string> labels = 5;
  // if true skip check if image exists.
  bool skip_image_check = 6;
  // Project ID.
  string project_id = 7;
}

// Response to create a new build in a capsule.
message CreateResponse {
  // ID of the build.
  string build_id = 1;
  // True if a new build was created.
  bool created_new_build = 2;
}

// Request to list builds.
message ListRequest {
  // Capsule to list builds in.
  string capsule_id = 1;
  // Pagination options.
  model.Pagination pagination = 2;
  // Project ID.
  string project_id = 3;
}

// Reponse to list builds.
message ListResponse {
  // Builds in the capsule.
  repeated api.v1.capsule.Build builds = 1;
  // Total number of builds in the capsule.
  uint64 total = 2;
}

// Request to delete a build.
message DeleteRequest {
  // Capsule to delete the build from.
  string capsule_id = 1;
  // Build to delete.
  string build_id = 2;
  // Project ID.
  string project_id = 3;
}

// Empty response to delete a build.
message DeleteResponse {}

// Request to get a build.
message GetRequest {
  // Capsule to get the build from.
  string capsule_id = 1;
  // Build to get.
  string build_id = 2;
  // Project ID.
  string project_id = 3;
}

// Response to get a build.
message GetResponse {
  // The build to retrieve
  api.v1.capsule.Build build = 1;
}
